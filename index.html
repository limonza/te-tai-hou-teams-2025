<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Te Tai Hou Teams - 2025</title>
<style>
  body { font-family: Arial, sans-serif; margin: 40px; background-color: #fafafa; color: #333; }
  .header-banner { display: flex; align-items: center; justify-content: center; margin-top: 20px; }
  .header-banner img { height: 80px; margin-right: 15px; }
  .header-banner h1 { margin: 0; }
  hr { margin: 20px 0; }
  .controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  input, select { padding: 6px 10px; border-radius: 4px; border: 1px solid #ccc; }
  button { padding: 6px 12px; border-radius: 4px; border: none; background-color: #2563eb; color: #fff; cursor: pointer; }
  button:hover { background-color: #1e40af; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f0f0f0; cursor: pointer; }
  tr:hover { background-color: #f9f9f9; }
  .group-header td { background-color: #e2e8f0; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>

<div class="header-banner">
<a href="https://www.poriruaheatbasketball.org" target="_blank">
  <img src="images/logo.png" alt="Heat Logo" width="50">
</a>
  <img src="images/logo.png" alt="Te Tai Hou Logo">
  <h1>TE TAI HOU TEAMS - 2025 TERM 4</h1>
</div>
<hr>

<div class="controls">
  <input type="text" id="search" placeholder="Search table...">
  <label for="teamFilter">Filter by Eligible Team:</label>
  <select id="teamFilter"><option value="">All Teams</option></select>
  <button id="export">Export Filtered Data</button>
</div>

<table id="data-table">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
(async function(){
  const table = document.getElementById('data-table');
  const tbody = table.tBodies[0];
  const thead = table.tHead;
  const search = document.getElementById('search');
  const teamFilter = document.getElementById('teamFilter');
  const exportBtn = document.getElementById('export');

  let allRows = [];
  let headers = [];
  let sortColumn = null;
  let sortAsc = true;

  // Custom group order
  const customGroupOrder = ['Starters', 'Development', 'Reserve'];
  const groupState = {}; // Tracks collapsed/expanded state by group

  // Load CSV
  const res = await fetch('data.csv');
  const text = await res.text();
  const lines = text.trim().split('\n');
  headers = lines[0].split(',').map(h => h.trim());
  allRows = lines.slice(1).map(line => line.split(','));

  // Render table headers
  const headerRow = document.createElement('tr');
  headers.forEach((header, i) => {
    const th = document.createElement('th');
    th.textContent = header;
    th.addEventListener('click', () => sortTable(i));
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  // Indexes for filters
  const teamIndex = headers.findIndex(h => h.toLowerCase() === 'eligible team');
  const groupIndex = headers.findIndex(h => h.toLowerCase() === 'indicative selection');
  const firstNameIndex = headers.findIndex(h => h.toLowerCase() === 'first name');

  // Populate dropdown
  const uniqueTeams = [...new Set(allRows.map(r => r[teamIndex]))].sort();
  uniqueTeams.forEach(team => {
    const opt = document.createElement('option');
    opt.value = team;
    opt.textContent = team;
    teamFilter.appendChild(opt);
  });

  // Initial render
  renderGroupedRows(allRows);

  // Event listeners for filters
  search.addEventListener('input', applyFilters);
  teamFilter.addEventListener('change', applyFilters);

  function applyFilters(){
    const q = search.value.trim().toLowerCase();
    const selectedTeam = teamFilter.value;
    const filtered = allRows.filter(row => {
      const matchesSearch = row.some(c => c.toLowerCase().includes(q));
      const matchesTeam = !selectedTeam || row[teamIndex] === selectedTeam;
      const hasGroup = row[groupIndex].trim() !== ''; // Exclude rows without group
      return matchesSearch && matchesTeam && hasGroup;
    });
    renderGroupedRows(filtered);
  }

  function renderGroupedRows(rows){
    tbody.innerHTML = '';
    const grouped = {};
    rows.forEach(r => {
      const key = r[groupIndex];
      if(!grouped[key]) grouped[key] = [];
      grouped[key].push(r);
    });

    // Sort groups according to custom order
    const sortedGroups = Object.keys(grouped).sort((a,b) => {
      const idxA = customGroupOrder.indexOf(a);
      const idxB = customGroupOrder.indexOf(b);
      if(idxA === -1 && idxB === -1) return a.localeCompare(b);
      if(idxA === -1) return 1;
      if(idxB === -1) return -1;
      return idxA - idxB;
    });

    sortedGroups.forEach(group => {
      // Sort rows in the group by First Name
      grouped[group].sort((a,b) => a[firstNameIndex].localeCompare(b[firstNameIndex]));

      // Render group header
      const trGroup = document.createElement('tr');
      trGroup.className = 'group-header';
      const tdGroup = document.createElement('td');
      tdGroup.colSpan = headers.length;

      // Default expanded if state not set
      if (!(group in groupState)) groupState[group] = false; // false = expanded
      tdGroup.textContent = (groupState[group] ? '▶ ' : '▼ ') + group;

      trGroup.appendChild(tdGroup);
      tbody.appendChild(trGroup);

      // Render rows
      const groupRows = grouped[group].map(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        // Hide rows if collapsed
        if (groupState[group]) tr.style.display = 'none';
        return tr;
      });
      groupRows.forEach(tr => tbody.appendChild(tr));

      // Collapsible toggle
      trGroup.addEventListener('click', () => {
        groupState[group] = !groupState[group]; // toggle state
        groupRows.forEach(tr => tr.style.display = groupState[group] ? 'none' : '');
        tdGroup.textContent = (groupState[group] ? '▶ ' : '▼ ') + group;
      });
    });
  }

  function sortTable(index){
    if(sortColumn === index) sortAsc = !sortAsc;
    else { sortColumn = index; sortAsc = true; }

    allRows.sort((a,b) => {
      const valA = a[index].toLowerCase();
      const valB = b[index].toLowerCase();
      if(valA < valB) return sortAsc ? -1 : 1;
      if(valA > valB) return sortAsc ? 1 : -1;
      return 0;
    });
    applyFilters(); // Re-render with new sort
  }

  exportBtn.addEventListener('click', () => {
    const rows = Array.from(tbody.querySelectorAll('tr')).map(r =>
      Array.from(r.children).map(td => td.textContent)
    );
    const csvContent = rows.map(r =>
      r.map(cell => `"${cell.replace(/"/g,'""')}"`).join(',')
    ).join('\n');
    const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'TeTaiHouTeams2025.csv';
    link.click();
  });

})();
</script>

</body>
</html>
