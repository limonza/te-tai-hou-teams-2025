<script>
const search = document.getElementById('search');
const selectionFilter = document.getElementById('selectionFilter');
const container = document.getElementById('table-container');
const exportBtn = document.getElementById('export');
const toggleGroupsBtn = document.getElementById('toggleGroups');

// === Add new filters for Cleared and GD Regist ===
const clearedFilter = document.createElement('select');
clearedFilter.id = 'clearedFilter';
clearedFilter.innerHTML = `
  <option value="">All Cleared</option>
  <option value="Blank">(Blank)</option>
`;

const gdFilter = document.createElement('select');
gdFilter.id = 'gdFilter';
gdFilter.innerHTML = `
  <option value="">All GD Regist.</option>
  <option value="Blank">(Blank)</option>
`;

document.querySelector('.controls').appendChild(clearedFilter);
document.querySelector('.controls').appendChild(gdFilter);

let headers = [];
let allRows = [];
let indicativeIndex = -1;
let clearedIndex = -1;
let gdIndex = -1;

const groupOrder = [
  "10U Dev","10U Elite","12U Dev","12U Elite",
  "14U Black","14U Orange","14U Blaze","14U Flames",
  "16U Dev","16U Elite","20U","Mens","Womens"
];

// --- Load CSV ---
fetch('teams.csv')
  .then(res => res.text())
  .then(text => {
    const lines = text.trim().split('\n').map(l => l.split(','));
    headers = lines[0].map(h => h.trim());
    indicativeIndex = headers.findIndex(h => h.toLowerCase() === 'indicative selection');

    // Add "Cleared" and "GD Regist." columns if missing
    if (!headers.includes("Cleared")) headers.push("Cleared");
    if (!headers.includes("GD Regist.")) headers.push("GD Regist.");

    clearedIndex = headers.findIndex(h => h === "Cleared");
    gdIndex = headers.findIndex(h => h === "GD Regist.");

    // Prepare rows and ensure both fields exist
    allRows = lines.slice(1)
      .map(r => {
        const trimmed = r.map(c => c.trim());
        // Ensure both Cleared and GD Regist. exist
        while (trimmed.length < headers.length) trimmed.push("");
        return trimmed;
      })
      .filter(r => r[indicativeIndex] && r[indicativeIndex] !== '');

    populateDropdowns();
    renderGroups(allRows);
  });

// --- Populate dropdowns ---
function populateDropdowns() {
  // Indicative selection dropdown
  const unique = [...new Set(allRows.map(r => r[indicativeIndex]))];
  const ordered = groupOrder.concat(unique.filter(v => !groupOrder.includes(v)));
  ordered.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    selectionFilter.appendChild(opt);
  });

  // Cleared dropdown
  const clearedValues = [...new Set(allRows.map(r => r[clearedIndex]).filter(v => v))];
  clearedValues.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    clearedFilter.appendChild(opt);
  });

  // GD Regist. dropdown
  const gdValues = [...new Set(allRows.map(r => r[gdIndex]).filter(v => v))];
  gdValues.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    gdFilter.appendChild(opt);
  });
}

// --- Render grouped tables ---
function renderGroups(rows) {
  container.innerHTML = '';

  const groups = rows.reduce((acc, row) => {
    const key = row[indicativeIndex];
    if (!acc[key]) acc[key] = [];
    acc[key].push(row);
    return acc;
  }, {});

  const filterVal = selectionFilter.value;
  const allGroupKeys = Object.keys(groups);
  const visibleKeys = filterVal
    ? [filterVal]
    : [...groupOrder.filter(g => allGroupKeys.includes(g)), ...allGroupKeys.filter(k => !groupOrder.includes(k))];

  visibleKeys.forEach(groupName => {
    const groupRows = groups[groupName];
    if (!groupRows?.length) return;

    const section = document.createElement('section');
    const header = document.createElement('div');
    header.className = 'group-header';
    header.innerHTML = `<span>${groupName}</span><span>(${groupRows.length}) â–¼</span>`;
    section.appendChild(header);

    const wrapper = document.createElement('div');
    wrapper.className = 'group-content';

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');

    headers.forEach((h, i) => {
