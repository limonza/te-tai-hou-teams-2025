<script>
const search = document.getElementById('search');
const selectionFilter = document.getElementById('selectionFilter');
const container = document.getElementById('table-container');
const exportBtn = document.getElementById('export');
const toggleGroupsBtn = document.getElementById('toggleGroups');

let headers = [];
let allRows = [];

const groupOrder = [
  "14U Dev", "16U Dev", "16U Elite", "18U", "Mens Social"
];

// --- Load CSV ---
fetch('HNC.csv')
  .then(res => res.text())
  .then(text => {
    const lines = text.trim().split('\n').map(l => l.split(',').map(c => c.trim()));
    headers = lines[0]; // [ "Name", "Team" ]
    allRows = lines.slice(1);

    populateDropdown();
    renderGroups(allRows);
  });

// --- Populate dropdown ---
function populateDropdown() {
  const uniqueTeams = [...new Set(allRows.map(r => r[1]))]; // team = 2nd column
  const ordered = groupOrder.concat(uniqueTeams.filter(v => !groupOrder.includes(v)));

  ordered.forEach(team => {
    const opt = document.createElement('option');
    opt.value = team;
    opt.textContent = team;
    selectionFilter.appendChild(opt);
  });
}

// --- Render grouped tables ---
function renderGroups(rows) {
  container.innerHTML = '';

  const groups = rows.reduce((acc, row) => {
    const team = row[1] || 'Unassigned'; // group by Team column
    if (!acc[team]) acc[team] = [];
    acc[team].push(row);
    return acc;
  }, {});

  const filterVal = selectionFilter.value;
  const allGroupKeys = Object.keys(groups);
  const visibleKeys = filterVal
    ? [filterVal]
    : [...groupOrder.filter(g => allGroupKeys.includes(g)), ...allGroupKeys.filter(k => !groupOrder.includes(k))];

  visibleKeys.forEach(teamName => {
    const teamRows = groups[teamName];
    if (!teamRows?.length) return;

    const section = document.createElement('section');

    // --- Group header ---
    const header = document.createElement('div');
    header.className = 'group-header';
    header.innerHTML = `<span>${teamName}</span><span>(${teamRows.length}) ▼</span>`;
    section.appendChild(header);

    // --- Table ---
    const wrapper = document.createElement('div');
    wrapper.className = 'group-content';
    const table = document.createElement('table');

    // Table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Table body
    const tbody = document.createElement('tbody');
    teamRows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach((c, i) => {
        const td = document.createElement('td');
        td.textContent = c;
        td.setAttribute('data-label', headers[i]);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    wrapper.appendChild(table);
    section.appendChild(wrapper);
    container.appendChild(section);

    // --- Toggle each group ---
    header.addEventListener('click', () => {
      wrapper.classList.toggle('hidden');
      const arrow = header.querySelector('span:last-child');
      arrow.textContent = wrapper.classList.contains('hidden')
        ? `(${teamRows.length}) ▲`
        : `(${teamRows.length}) ▼`;
    });
  });
}

// --- Search & Filter ---
function applyFilters() {
  const q = search.value.toLowerCase();
  const sel = selectionFilter.value;
  const filtered = allRows.filter(r => {
    const matchesSearch = r.some(c => c.toLowerCase().includes(q));
    const matchesSel = !sel || r[1] === sel;
    return matchesSearch && matchesSel;
  });
  renderGroups(filtered);
}

search.addEventListener('input', applyFilters);
selectionFilter.addEventListener('change', applyFilters);

// --- Export visible ---
exportBtn.addEventListener('click', () => {
  const rows = [];
  rows.push(headers.join(','));
  container.querySelectorAll('section').forEach(section => {
    const wrapper = section.querySelector('.group-content');
    if (wrapper.classList.contains('hidden')) return;
    wrapper.querySelectorAll('tbody tr').forEach(tr => {
      const cells = Array.from(tr.children).map(td => td.textContent);
      rows.push(cells.join(','));
    });
  });
  const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  lin
